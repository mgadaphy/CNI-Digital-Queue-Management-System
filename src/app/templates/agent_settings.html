{% extends "base.html" %}

{% block header %}
<div class="agent-header bg-light border-bottom">
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid px-0">
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('agent.agent_dashboard') }}"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                    <a class="nav-link" href="{{ url_for('agent.agent_profile') }}"><i class="fas fa-user me-1"></i>Profile</a>
                    <a class="nav-link active" href="{{ url_for('agent.agent_settings') }}"><i class="fas fa-cog me-1"></i>Settings</a>
                </div>
            </div>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-cog me-2"></i>Agent Settings</h4>
                </div>
                <div class="card-body">
                    <div id="alertContainer"></div>
                    
                    <form id="settingsForm">
                        <!-- Work Preferences Section -->
                        <div class="mb-4">
                            <h5><i class="fas fa-briefcase me-2"></i>Work Preferences</h5>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="currentStation" class="form-label">Current Station</label>
                                        <select class="form-select" id="currentStation" name="currentStation">
                                            <option value="">Select a station...</option>
                                            {% for station in stations %}
                                                <option value="{{ station.id }}" 
                                                        {% if agent.current_station_id == station.id %}selected{% endif %}>
                                                    {{ station.name }} ({{ station.station_number }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Service Specializations</label>
                                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                            {% for service_type in service_types %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           id="service_{{ service_type.id }}" 
                                                           name="specializations" 
                                                           value="{{ service_type.id }}"
                                                           {% if agent.specializations and service_type.id in (agent.specializations or []) %}checked{% endif %}>
                                                    <label class="form-check-label" for="service_{{ service_type.id }}">
                                                        {{ service_type.name_fr }} ({{ service_type.code }})
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="form-text">Select services you are specialized in</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Preferences Section -->
                        <div class="mb-4">
                            <h5><i class="fas fa-bell me-2"></i>Notification Preferences</h5>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailNotifications" 
                                               name="emailNotifications" checked>
                                        <label class="form-check-label" for="emailNotifications">
                                            Email Notifications
                                        </label>
                                        <div class="form-text">Receive email notifications for important updates</div>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="queueAlerts" 
                                               name="queueAlerts" checked>
                                        <label class="form-check-label" for="queueAlerts">
                                            Queue Alerts
                                        </label>
                                        <div class="form-text">Get notified when new citizens are assigned to you</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="systemUpdates" 
                                               name="systemUpdates" checked>
                                        <label class="form-check-label" for="systemUpdates">
                                            System Updates
                                        </label>
                                        <div class="form-text">Receive notifications about system maintenance and updates</div>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="performanceReports" 
                                               name="performanceReports">
                                        <label class="form-check-label" for="performanceReports">
                                            Performance Reports
                                        </label>
                                        <div class="form-text">Receive weekly performance summary reports</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Display Preferences Section -->
                        <div class="mb-4">
                            <h5><i class="fas fa-desktop me-2"></i>Display Preferences</h5>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="language" class="form-label">Preferred Language</label>
                                        <select class="form-select" id="language" name="language">
                                            <option value="fr">Fran√ßais (French)</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="theme" class="form-label">Theme</label>
                                        <select class="form-select" id="theme" name="theme">
                                            <option value="light">Light</option>
                                            <option value="dark">Dark</option>
                                            <option value="auto">Auto (System)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats Section -->
                        <div class="mb-4">
                            <h5><i class="fas fa-chart-line me-2"></i>Quick Stats</h5>
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-primary">{{ agent.status|title }}</h5>
                                            <p class="card-text">Current Status</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-success">
                                                {% if agent.current_station_id %}
                                                    {% set current_station = stations|selectattr('id', 'equalto', agent.current_station_id)|list %}
                                                    {% if current_station %}
                                                        {{ current_station[0].name }}
                                                    {% else %}
                                                        Station #{{ agent.current_station_id }}
                                                    {% endif %}
                                                {% else %}
                                                    Not Assigned
                                                {% endif %}
                                            </h5>
                                            <p class="card-text">Assigned Station</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-info">
                                                {{ (agent.specializations or [])|length }}
                                            </h5>
                                            <p class="card-text">Specializations</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h5 class="card-title text-warning">Active</h5>
                                            <p class="card-text">Account Status</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('agent.agent_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save me-1"></i>Save Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// CSRF token function
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// Show alert function
function showAlert(message, type = 'success') {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alertDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

document.addEventListener('DOMContentLoaded', function() {
    const settingsForm = document.getElementById('settingsForm');
    const saveBtn = document.getElementById('saveBtn');
    
    settingsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(settingsForm);
        
        // Get selected specializations
        const specializations = [];
        document.querySelectorAll('input[name="specializations"]:checked').forEach(checkbox => {
            specializations.push(parseInt(checkbox.value));
        });
        
        // Prepare data to send
        const updateData = {
            preferred_station_id: formData.get('currentStation') ? parseInt(formData.get('currentStation')) : null,
            specializations: specializations,
            email_notifications: formData.get('emailNotifications') === 'on',
            queue_alerts: formData.get('queueAlerts') === 'on',
            system_updates: formData.get('systemUpdates') === 'on',
            performance_reports: formData.get('performanceReports') === 'on',
            language: formData.get('language'),
            theme: formData.get('theme')
        };
        
        // Show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        
        try {
            const response = await fetch('{{ url_for("agent.update_agent_settings") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': getCsrfToken()
                },
                body: JSON.stringify(updateData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message, 'success');
            } else {
                showAlert(data.message, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('An error occurred while updating settings', 'danger');
        } finally {
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Settings';
        }
    });
});
</script>
{% endblock %}
