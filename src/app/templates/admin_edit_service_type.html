{% extends "base.html" %}

{% block header %}
<div class="admin-header bg-light border-bottom">
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid px-0">
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('admin.admin_dashboard') }}"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_agents') }}"><i class="fas fa-users me-1"></i>Agents</a>
                    <a class="nav-link active" href="{{ url_for('admin.manage_service_types') }}"><i class="fas fa-cogs me-1"></i>Service Types</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_stations') }}"><i class="fas fa-desktop me-1"></i>Stations</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_citizens') }}"><i class="fas fa-user-friends me-1"></i>Citizens</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_queue') }}"><i class="fas fa-list-ol me-1"></i>Queue</a>
                    <a class="nav-link" href="{{ url_for('admin.system_reports') }}"><i class="fas fa-chart-bar me-1"></i>Reports</a>
                </div>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            {% if current_user %}
                                {{ current_user.first_name }} {{ current_user.last_name }}
                            {% else %}
                                Admin User
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('admin.admin_profile') }}"><i class="fas fa-user me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.admin_settings') }}"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        {% if service_type %}
                            Edit Service Type: {{ service_type.name_en or service_type.name_fr or 'Unnamed' }}
                        {% else %}
                            Add New Service Type
                        {% endif %}
                    </h3>
                    <a href="{{ url_for('admin.manage_service_types') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Service Types
                    </a>
                </div>
                <div class="card-body">
                    <form id="serviceTypeForm" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name_en" class="form-label">Service Type Name (English) *</label>
                                    <input type="text" class="form-control" id="name_en" name="name_en" 
                                           value="{{ service_type.name_en if service_type else '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name_fr" class="form-label">Service Type Name (French) *</label>
                                    <input type="text" class="form-control" id="name_fr" name="name_fr" 
                                           value="{{ service_type.name_fr if service_type else '' }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="code" class="form-label">Service Code *</label>
                                    <input type="text" class="form-control" id="code" name="code" 
                                           value="{{ service_type.code if service_type else '' }}" 
                                           placeholder="e.g., GEN, PRI, SPC" required>
                                    <small class="form-text text-muted">Short code for the service type (3-5 characters)</small>
                                </div>
                            </div>
                        </div>
                        
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="description_en" class="form-label">Description (English)</label>
                                    <textarea class="form-control" id="description_en" name="description_en" rows="3">{{ service_type.description_en if service_type else '' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="description_fr" class="form-label">Description (French)</label>
                                    <textarea class="form-control" id="description_fr" name="description_fr" rows="3">{{ service_type.description_fr if service_type else '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="estimated_duration" class="form-label">Estimated Service Duration (minutes)</label>
                                    <input type="number" class="form-control" id="estimated_duration" name="estimated_duration" 
                                           value="{{ service_type.estimated_duration if service_type else '' }}" min="1" max="120" required>
                                    <small class="form-text text-muted">Average time to complete this service</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="priority_level" class="form-label">Priority Level</label>
                                    <select class="form-select" id="priority_level" name="priority_level" required>
                                        <option value="1" {{ 'selected' if service_type and service_type.priority_level == 1 else '' }}>Low (1)</option>
                                        <option value="2" {{ 'selected' if service_type and service_type.priority_level == 2 else '' }}>Normal (2)</option>
                                        <option value="3" {{ 'selected' if service_type and service_type.priority_level == 3 else '' }}>High (3)</option>
                                        <option value="4" {{ 'selected' if service_type and service_type.priority_level == 4 else '' }}>Urgent (4)</option>
                                        <option value="5" {{ 'selected' if service_type and service_type.priority_level == 5 else '' }}>Critical (5)</option>
                                    </select>
                                    <small class="form-text text-muted">Higher priority services are served first</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="color" class="form-label">Display Color</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="color" name="color" 
                                               value="{{ service_type.color if service_type and service_type.color else '#007bff' }}" 
                                               style="width: 60px;">
                                        <input type="text" class="form-control" id="colorText" placeholder="#007bff" readonly>
                                    </div>
                                    <small class="form-text text-muted">Color used in displays and reports</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" 
                                               {{ 'checked' if service_type and service_type.is_active else '' }}>
                                        <label class="form-check-label" for="is_active">
                                            Active Service Type
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Only active service types can be selected for new tickets</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="requires_appointment" name="requires_appointment" 
                                               {{ 'checked' if service_type and service_type.requires_appointment else '' }}>
                                        <label class="form-check-label" for="requires_appointment">
                                            Requires Appointment
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Citizens must book an appointment for this service</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Required Documents</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_id" name="required_documents" value="id"
                                               {% if service_type and service_type.required_documents and 'id' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_id">ID Document</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_proof_address" name="required_documents" value="proof_address"
                                               {% if service_type and service_type.required_documents and 'proof_address' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_proof_address">Proof of Address</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_birth_cert" name="required_documents" value="birth_certificate"
                                               {% if service_type and service_type.required_documents and 'birth_certificate' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_birth_cert">Birth Certificate</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_passport" name="required_documents" value="passport"
                                               {% if service_type and service_type.required_documents and 'passport' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_passport">Passport</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_photos" name="required_documents" value="photos"
                                               {% if service_type and service_type.required_documents and 'photos' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_photos">Passport Photos</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="req_other" name="required_documents" value="other"
                                               {% if service_type and service_type.required_documents and 'other' in (service_type.required_documents if service_type.required_documents is string else service_type.required_documents|default([])) %}checked{% endif %}>
                                        <label class="form-check-label" for="req_other">Other Documents</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="instructions" class="form-label">Service Instructions</label>
                            <textarea class="form-control" id="instructions" name="instructions" rows="4" placeholder="Instructions for citizens about this service..."></textarea>
                            <small class="form-text text-muted">Instructions displayed to citizens when selecting this service</small>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                {% if service_type %}
                                    <button type="button" class="btn btn-danger" onclick="deleteServiceType()">
                                        <i class="fas fa-trash"></i> Delete Service Type
                                    </button>
                                {% endif %}
                            </div>
                            <div>
                                <a href="{{ url_for('admin.manage_service_types') }}" class="btn btn-secondary me-2">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    {% if service_type %}
                                        Update Service Type
                                    {% else %}
                                        Create Service Type
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Card -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Service Type Preview</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="service-color-preview me-3" id="colorPreview" style="width: 20px; height: 20px; border-radius: 3px; background-color: #007bff;"></div>
                    <div>
                        <h6 class="mb-0" id="namePreview">Service Type Name</h6>
                        <small class="text-muted" id="codePreview">CODE</small>
                    </div>
                </div>
                <p class="text-muted" id="descriptionPreview">Service description will appear here...</p>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Estimated Time:</small><br>
                        <strong id="timePreview">-- minutes</strong>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Priority:</small><br>
                        <strong id="priorityPreview">--</strong>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">Status:</small>
                    <span class="badge bg-success ms-2" id="statusPreview">Active</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update preview in real-time
function updatePreview() {
    const name = document.getElementById('name_en').value || 'Service Type Name';
    const code = document.getElementById('code').value || 'CODE';
    const description = document.getElementById('description_en').value || 'Service description will appear here...';
    const time = document.getElementById('estimated_duration').value || '--';
    const priority = document.getElementById('priority_level').value || '--';
    const color = document.getElementById('color').value;
    const isActive = document.getElementById('is_active').checked;
    
    document.getElementById('namePreview').textContent = name;
    document.getElementById('codePreview').textContent = code;
    document.getElementById('descriptionPreview').textContent = description;
    document.getElementById('timePreview').textContent = time + ' minutes';
    document.getElementById('priorityPreview').textContent = priority;
    document.getElementById('colorPreview').style.backgroundColor = color;
    document.getElementById('colorText').value = color;
    
    const statusBadge = document.getElementById('statusPreview');
    if (isActive) {
        statusBadge.className = 'badge bg-success ms-2';
        statusBadge.textContent = 'Active';
    } else {
        statusBadge.className = 'badge bg-secondary ms-2';
        statusBadge.textContent = 'Inactive';
    }
}

// Add event listeners for real-time preview
document.getElementById('name_en').addEventListener('input', updatePreview);
document.getElementById('code').addEventListener('input', updatePreview);
document.getElementById('description_en').addEventListener('input', updatePreview);
document.getElementById('estimated_duration').addEventListener('input', updatePreview);
document.getElementById('priority_level').addEventListener('change', updatePreview);
document.getElementById('color').addEventListener('input', updatePreview);
document.getElementById('is_active').addEventListener('change', updatePreview);

// Update color text field
document.getElementById('color').addEventListener('input', function() {
    document.getElementById('colorText').value = this.value;
});

// Initialize preview
updatePreview();

// Handle form submission
document.getElementById('serviceTypeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Collect required documents
    const requiredDocs = [];
    document.querySelectorAll('input[name="required_documents"]:checked').forEach(checkbox => {
        requiredDocs.push(checkbox.value);
    });
    
    const formData = {
        name_en: document.getElementById('name_en').value,
        name_fr: document.getElementById('name_fr').value,
        code: document.getElementById('code').value,
        description_en: document.getElementById('description_en').value,
        description_fr: document.getElementById('description_fr').value,
        estimated_duration: parseInt(document.getElementById('estimated_duration').value),
        priority_level: parseInt(document.getElementById('priority_level').value),
        color: document.getElementById('color').value,
        is_active: document.getElementById('is_active').checked,
        requires_appointment: document.getElementById('requires_appointment').checked,
        required_documents: JSON.stringify(requiredDocs),
        instructions: document.getElementById('instructions').value
    };
    
    const url = {% if service_type %}"{{ url_for('admin.edit_service_type', service_type_id=service_type.id) }}"{% else %}"{{ url_for('admin.create_service_type') }}"{% endif %};
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = "{{ url_for('admin.manage_service_types') }}";
        } else {
            alert('Error: ' + (data.message || 'Failed to save service type'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the service type');
    });
});

{% if service_type %}
function deleteServiceType() {
    if (confirm('Are you sure you want to delete this service type? This action cannot be undone.')) {
        fetch("{{ url_for('admin.delete_service_type', service_type_id=service_type.id) }}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{{ url_for('admin.manage_service_types') }}";
            } else {
                alert('Error: ' + (data.message || 'Failed to delete service type'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the service type');
        });
    }
}
{% endif %}
</script>
{% endblock %}