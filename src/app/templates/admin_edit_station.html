{% extends "base.html" %}

{% block header %}
<div class="admin-header bg-light border-bottom">
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid px-0">
                <div class="navbar-nav">
                    <a class="nav-link" href="{{ url_for('admin.admin_dashboard') }}"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_agents') }}"><i class="fas fa-users me-1"></i>Agents</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_service_types') }}"><i class="fas fa-cogs me-1"></i>Service Types</a>
                    <a class="nav-link active" href="{{ url_for('admin.manage_stations') }}"><i class="fas fa-desktop me-1"></i>Stations</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_citizens') }}"><i class="fas fa-user-friends me-1"></i>Citizens</a>
                    <a class="nav-link" href="{{ url_for('admin.manage_queue') }}"><i class="fas fa-list-ol me-1"></i>Queue</a>
                    <a class="nav-link" href="{{ url_for('admin.system_reports') }}"><i class="fas fa-chart-bar me-1"></i>Reports</a>
                </div>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            {% if current_user %}
                                {{ current_user.first_name }} {{ current_user.last_name }}
                            {% else %}
                                Admin User
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('admin.admin_profile') }}"><i class="fas fa-user me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.admin_settings') }}"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

        <!-- Main Content -->
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-edit me-2"></i>Edit Station: {{ station.name }}</h4>
                    </div>
                    <div class="card-body">
                        <form id="editStationForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <label for="station_number" class="form-label">Station Number *</label>
                                <input type="text" class="form-control" id="station_number" name="station_number" value="{{ station.station_number }}" required>
                            </div>

                            <div class="mb-3">
                                <label for="name" class="form-label">Station Name *</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ station.name }}" required>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{{ station.description or '' }}</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location" value="{{ station.location or '' }}" placeholder="e.g., Ground Floor, Room 101">
                            </div>

                            <div class="mb-3">
                                <label for="supported_services" class="form-label">Supported Services</label>
                                <select class="form-control" id="supported_services" name="supported_services" multiple>
                                    {% for service_type in service_types %}
                                    <option value="{{ service_type.id }}" {% if station.supported_services and service_type.id in station.supported_services %}selected{% endif %}>
                                        {{ service_type.name_en }} ({{ service_type.code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl to select multiple services</small>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if station.is_active %}checked{% endif %}>
                                    <label class="form-check-label" for="is_active">
                                        Active Station
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('admin.manage_stations') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Update Station
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    
    <script>
        document.getElementById('editStationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const supportedServicesSelect = document.getElementById('supported_services');
            const selectedServices = Array.from(supportedServicesSelect.selectedOptions).map(option => parseInt(option.value));
            
            const formData = {
                station_number: document.getElementById('station_number').value,
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                location: document.getElementById('location').value,
                supported_services: selectedServices,
                is_active: document.getElementById('is_active').checked
            };
            
            try {
                const response = await fetch("{{ url_for('admin.edit_station', station_id=station.id) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Station updated successfully!');
                    window.location.href = "{{ url_for('admin.manage_stations') }}";
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating the station.');
            }
        });
    </script>
{% endblock %}